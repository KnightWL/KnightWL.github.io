<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Lei Wang">
  <!-- Open Graph Data -->
  <meta property="og:title" content="AFNetworking 内存泄漏问题"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="fantasineer"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://fantasineer.com"/>
  
    <link rel="alternate" href="/atom.xml" title="fantasineer" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>fantasineer</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">AFNetworking 内存泄漏问题</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/<your-github-username>">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:<your-email-address>">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Lei Wang</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2017-04-15</span>
            <span class="time">17:25:30</span>
          </span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/iOS/">#iOS</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h4 id="前几天突心血来潮用instruments跑了跑之前从同事手里接过来的项目，结果一跑就让我抓到了个AFN的问题。"><a href="#前几天突心血来潮用instruments跑了跑之前从同事手里接过来的项目，结果一跑就让我抓到了个AFN的问题。" class="headerlink" title="前几天突心血来潮用instruments跑了跑之前从同事手里接过来的项目，结果一跑就让我抓到了个AFN的问题。"></a>前几天突心血来潮用instruments跑了跑之前从同事手里接过来的项目，结果一跑就让我抓到了个AFN的问题。</h4><h5 id="每向后台发出一次请求，就通过instruments截获到一个内存泄漏，而且每次请求发出后发生内存泄漏的call-tree和retain-circle都是一样的如下2图："><a href="#每向后台发出一次请求，就通过instruments截获到一个内存泄漏，而且每次请求发出后发生内存泄漏的call-tree和retain-circle都是一样的如下2图：" class="headerlink" title="每向后台发出一次请求，就通过instruments截获到一个内存泄漏，而且每次请求发出后发生内存泄漏的call tree和retain circle都是一样的如下2图："></a>每向后台发出一次请求，就通过instruments截获到一个内存泄漏，而且每次请求发出后发生内存泄漏的call tree和retain circle都是一样的如下2图：</h5><p><img src="http://i2.muimg.com/567571/39e96918332ed6ae.png" alt=""><br><img src="http://i2.muimg.com/567571/118de333896860cf.png" alt=""></p>
<h5 id="那么问题已经非常明显了，我特意去查了下NSURLSession的delegate持有方式为strong，而AFURLManager及其子类对象对NSURLSession对象为强引用，且恰恰AFURLManager及其子类对象遵守了NSURLSessionDelegate，所以造成了循环引用，请求结束后NSURLSession对象与AFURLManager对象并没有得到释放，造成了内存泄漏。"><a href="#那么问题已经非常明显了，我特意去查了下NSURLSession的delegate持有方式为strong，而AFURLManager及其子类对象对NSURLSession对象为强引用，且恰恰AFURLManager及其子类对象遵守了NSURLSessionDelegate，所以造成了循环引用，请求结束后NSURLSession对象与AFURLManager对象并没有得到释放，造成了内存泄漏。" class="headerlink" title="那么问题已经非常明显了，我特意去查了下NSURLSession的delegate持有方式为strong，而AFURLManager及其子类对象对NSURLSession对象为强引用，且恰恰AFURLManager及其子类对象遵守了NSURLSessionDelegate，所以造成了循环引用，请求结束后NSURLSession对象与AFURLManager对象并没有得到释放，造成了内存泄漏。"></a>那么问题已经非常明显了，我特意去查了下NSURLSession的delegate持有方式为strong，而AFURLManager及其子类对象对NSURLSession对象为强引用，且恰恰AFURLManager及其子类对象遵守了NSURLSessionDelegate，所以造成了循环引用，请求结束后NSURLSession对象与AFURLManager对象并没有得到释放，造成了内存泄漏。</h5><h5 id="特意去调研了一下这个问题应该是session的ARC机制下的历史遗留问题，那么既然如此如何去解决呢？"><a href="#特意去调研了一下这个问题应该是session的ARC机制下的历史遗留问题，那么既然如此如何去解决呢？" class="headerlink" title="特意去调研了一下这个问题应该是session的ARC机制下的历史遗留问题，那么既然如此如何去解决呢？"></a>特意去调研了一下这个问题应该是session的ARC机制下的历史遗留问题，那么既然如此如何去解决呢？</h5><h5 id="两种方法："><a href="#两种方法：" class="headerlink" title="两种方法："></a>两种方法：</h5><ul>
<li>将session写成单例，将AFURLManager对session的引用改成weak</li>
<li>将manager写成单例<blockquote>
<p>第一种方法非常好理解，既然是session的历史遗留问题，那么直接从session下手将其改为单例之后session常驻内存不用担心被释放掉，所以session的生命周期长于持有它的manager，可以放心的将manager对session的引用改为weak；<br>第二种看上去有点舍近求远，明明是session的问题，改manager有什么用的？点进afn的源码就会发现，session的创建都是在manager中进行的，而且manager内部不存在修改session的代码，那么将manager封装成单例的话，session也就相应的变成了单例，虽然它们之间的循环引用还存在，但是这已经不会造成任何内存泄漏问题了–单例的生命周期等同于app生命周期。</p>
</blockquote>
</li>
</ul>
<hr>
<h5 id="对比一下两种解决办法的优劣："><a href="#对比一下两种解决办法的优劣：" class="headerlink" title="对比一下两种解决办法的优劣："></a>对比一下两种解决办法的优劣：</h5><ul>
<li>第一种简单容易理解，错误出在哪里就去哪里解决，但是因为session是在manager内部创建的，而且我们要将session改成单例还需要去改manager对session的强引用，就造成了对AFN内部代码的大量修改。</li>
<li>我个人更推荐第二种算法，因为它看似舍近求远，但是其实是从最根源解决了AFN的内存泄漏问题， 并且manager的创建一般都是在我们对AFN的二次封装或者直接使用时进行的，所以不需要修改AFN内部代码，工作量也小于第一种。</li>
</ul>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

